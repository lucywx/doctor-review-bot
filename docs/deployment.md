# éƒ¨ç½²ä¸é…ç½®æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•å°† Doctor Review Bot éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

---

## 1. éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Meta (WhatsApp Business Cloud API)         â”‚
â”‚  - Webhook æ¥æ”¶/å‘é€æ¶ˆæ¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTPS
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Railway / Render / Heroku                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastAPI åº”ç”¨ (Docker å®¹å™¨)           â”‚  â”‚
â”‚  â”‚  - Port 8000                           â”‚  â”‚
â”‚  â”‚  - Gunicorn + Uvicorn Workers          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL æ•°æ®åº“                     â”‚  â”‚
â”‚  â”‚  - å†…ç½®æ‰˜ç®¡ / Supabase                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    å¤–éƒ¨ APIï¼ˆGoogleã€Facebookã€OpenAIï¼‰
```

---

## 2. æ¨èéƒ¨ç½²å¹³å°

### 2.1 Railwayï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… å…è´¹ $5/æœˆé¢åº¦
- âœ… è‡ªåŠ¨éƒ¨ç½²ï¼ˆGit Pushï¼‰
- âœ… å†…ç½® PostgreSQL
- âœ… ç®€å•é…ç½®

**æˆæœ¬**ï¼š
- å…è´¹é¢åº¦ï¼š$5/æœˆ
- è¶…å‡ºåï¼šæŒ‰ä½¿ç”¨é‡è®¡è´¹

### 2.2 Render

**ä¼˜åŠ¿**ï¼š
- âœ… å…è´¹é™æ€ç«™ç‚¹
- âœ… PostgreSQL å…è´¹ç‰ˆï¼ˆ90 å¤©é™åˆ¶ï¼‰
- âœ… è‡ªåŠ¨ HTTPS

**æˆæœ¬**ï¼š
- Web Serviceï¼šå…è´¹ï¼ˆæœ‰é™åˆ¶ï¼‰
- ä»˜è´¹ï¼š$7/æœˆ

### 2.3 Heroku

**ä¼˜åŠ¿**ï¼š
- âœ… æˆç†Ÿç¨³å®š
- âœ… ä¸°å¯Œæ’ä»¶

**æˆæœ¬**ï¼š
- Eco Dynoï¼š$5/æœˆ
- PostgreSQLï¼š$0-9/æœˆ

---

## 3. Railway éƒ¨ç½²æ­¥éª¤ï¼ˆè¯¦ç»†ï¼‰

### æ­¥éª¤ 1ï¼šå‡†å¤‡é¡¹ç›®æ–‡ä»¶

#### 3.1 åˆ›å»º `Dockerfile`

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 3.2 åˆ›å»º `requirements.txt`

```txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
httpx==0.26.0
asyncpg==0.29.0
sqlalchemy==2.0.25
python-dotenv==1.0.0
openai==1.10.0
beautifulsoup4==4.12.3
pydantic==2.5.3
pydantic-settings==2.1.0
```

#### 3.3 åˆ›å»º `railway.json`

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile"
  },
  "deploy": {
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### æ­¥éª¤ 2ï¼šRailway é…ç½®

1. **ç™»å½• Railway**
   - è®¿é—® [railway.app](https://railway.app)
   - ä½¿ç”¨ GitHub ç™»å½•

2. **åˆ›å»ºæ–°é¡¹ç›®**
   ```bash
   # æ–¹å¼ 1ï¼šWeb ç•Œé¢
   New Project â†’ Deploy from GitHub repo â†’ é€‰æ‹©ä»“åº“

   # æ–¹å¼ 2ï¼šCLI
   npm install -g @railway/cli
   railway login
   railway init
   railway up
   ```

3. **æ·»åŠ  PostgreSQL**
   ```
   New â†’ Database â†’ PostgreSQL
   ```

4. **é…ç½®ç¯å¢ƒå˜é‡**
   - è¿›å…¥é¡¹ç›® â†’ Variables
   - æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

   ```bash
   # Database (Railway è‡ªåŠ¨ç”Ÿæˆ)
   DATABASE_URL=${{Postgres.DATABASE_URL}}

   # WhatsApp
   WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
   WHATSAPP_ACCESS_TOKEN=your_access_token
   VERIFY_TOKEN=your_verify_token

   # Google
   GOOGLE_PLACES_API_KEY=your_google_api_key

   # Facebook
   FACEBOOK_ACCESS_TOKEN=your_facebook_token

   # OpenAI
   OPENAI_API_KEY=your_openai_key

   # App Settings
   ENVIRONMENT=production
   DEBUG=false
   ```

5. **ç”Ÿæˆå…¬ç½‘åŸŸå**
   ```
   Settings â†’ Networking â†’ Generate Domain
   ```
   è·å¾—ç±»ä¼¼ï¼š`https://your-app.up.railway.app`

### æ­¥éª¤ 3ï¼šé…ç½® WhatsApp Webhook

1. è®¿é—® [Meta for Developers](https://developers.facebook.com/)
2. è¿›å…¥ä½ çš„ WhatsApp åº”ç”¨
3. é…ç½® Webhookï¼š
   - Callback URL: `https://your-app.up.railway.app/webhook/whatsapp`
   - Verify Token: ä¸ç¯å¢ƒå˜é‡ä¸­çš„ `VERIFY_TOKEN` ä¸€è‡´
   - Webhook Fields: å‹¾é€‰ `messages`

### æ­¥éª¤ 4ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
# æ–¹å¼ 1ï¼šRailway CLI
railway run python scripts/init_db.py

# æ–¹å¼ 2ï¼šRailway Shell
railway shell
python scripts/init_db.py
```

`scripts/init_db.py`ï¼š

```python
import asyncpg
import os
from dotenv import load_dotenv

load_dotenv()

async def init_database():
    conn = await asyncpg.connect(os.getenv("DATABASE_URL"))

    # è¯»å–å¹¶æ‰§è¡Œ SQL æ–‡ä»¶
    with open("sql/schema.sql", "r") as f:
        sql = f.read()
        await conn.execute(sql)

    print("âœ… Database initialized successfully")
    await conn.close()

if __name__ == "__main__":
    import asyncio
    asyncio.run(init_database())
```

---

## 4. Docker æœ¬åœ°æµ‹è¯•

### 4.1 åˆ›å»º `docker-compose.yml`

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/doctor_review
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - db
    volumes:
      - ./src:/app/src

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=doctor_review
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 4.2 å¯åŠ¨å®¹å™¨

```bash
# å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢
docker-compose down
```

---

## 5. ç¯å¢ƒå˜é‡ç®¡ç†

### 5.1 `.env` æ–‡ä»¶ï¼ˆæœ¬åœ°å¼€å‘ï¼‰

```bash
# .env
DATABASE_URL=postgresql://user:password@localhost:5432/doctor_review
WHATSAPP_PHONE_NUMBER_ID=123456789
WHATSAPP_ACCESS_TOKEN=EAAxxxx...
VERIFY_TOKEN=my_secret_token
GOOGLE_PLACES_API_KEY=AIzaxxxx
FACEBOOK_ACCESS_TOKEN=EAAyyyy
OPENAI_API_KEY=sk-xxxx
ENVIRONMENT=development
DEBUG=true
```

### 5.2 é…ç½®åŠ è½½

```python
# src/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Database
    database_url: str

    # WhatsApp
    whatsapp_phone_number_id: str
    whatsapp_access_token: str
    verify_token: str

    # APIs
    google_places_api_key: str
    facebook_access_token: str
    openai_api_key: str

    # App
    environment: str = "development"
    debug: bool = False

    class Config:
        env_file = ".env"

settings = Settings()
```

---

## 6. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 6.1 ä½¿ç”¨ Gunicorn + Uvicorn

```bash
# å®‰è£…
pip install gunicorn

# å¯åŠ¨å‘½ä»¤ï¼ˆDockerfile ä¸­ï¼‰
CMD ["gunicorn", "src.main:app", \
     "--workers", "4", \
     "--worker-class", "uvicorn.workers.UvicornWorker", \
     "--bind", "0.0.0.0:8000"]
```

### 6.2 æ—¥å¿—é…ç½®

```python
# src/logging_config.py
import logging
import sys

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s [%(levelname)s] %(name)s: %(message)s",
        handlers=[
            logging.StreamHandler(sys.stdout),
            logging.FileHandler("app.log")
        ]
    )

# src/main.py
from logging_config import setup_logging

setup_logging()
logger = logging.getLogger(__name__)
```

### 6.3 å¥åº·æ£€æŸ¥ç«¯ç‚¹

```python
@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    try:
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
        await db.execute("SELECT 1")
        return {"status": "healthy", "database": "ok"}
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}, 500
```

---

## 7. æ•°æ®åº“å¤‡ä»½

### 7.1 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh

# ä» Railway è·å–æ•°æ®åº“ URL
DATABASE_URL=$(railway variables get DATABASE_URL)

# å¤‡ä»½æ–‡ä»¶å
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"

# å¯¼å‡ºæ•°æ®åº“
pg_dump $DATABASE_URL > $BACKUP_FILE

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $BACKUP_FILE s3://your-bucket/backups/

echo "âœ… Backup completed: $BACKUP_FILE"
```

### 7.2 å®šæ—¶å¤‡ä»½ï¼ˆCronï¼‰

```bash
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /path/to/backup.sh
```

---

## 8. ç›‘æ§ä¸å‘Šè­¦

### 8.1 ä½¿ç”¨ Railway å†…ç½®ç›‘æ§

- CPU ä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- è¯·æ±‚å“åº”æ—¶é—´

### 8.2 åº”ç”¨çº§ç›‘æ§ï¼ˆSentryï¼‰

```bash
pip install sentry-sdk[fastapi]
```

```python
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn="your_sentry_dsn",
    integrations=[FastApiIntegration()],
    traces_sample_rate=0.1
)
```

### 8.3 æ—¥å¿—èšåˆï¼ˆLogtailï¼‰

```bash
pip install logtail-python
```

```python
from logtail import LogtailHandler
import logging

handler = LogtailHandler(source_token="your_token")
logger = logging.getLogger(__name__)
logger.addHandler(handler)
```

---

## 9. å®‰å…¨é…ç½®

### 9.1 HTTPS å¼ºåˆ¶

Railway è‡ªåŠ¨æä¾› HTTPSï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 9.2 ç¯å¢ƒå˜é‡åŠ å¯†

ä½¿ç”¨ Railway Secretsï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰ã€‚

### 9.3 é€Ÿç‡é™åˆ¶

```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter

@app.post("/webhook/whatsapp")
@limiter.limit("10/minute")
async def webhook(request: Request):
    # ...
    pass
```

---

## 10. CI/CD é…ç½®

### 10.1 GitHub Actions

`.github/workflows/deploy.yml`ï¼š

```yaml
name: Deploy to Railway

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

### 10.2 è‡ªåŠ¨æµ‹è¯•

```yaml
# åœ¨ deploy å‰æ·»åŠ æµ‹è¯•æ­¥éª¤
- name: Run Tests
  run: |
    pip install -r requirements.txt
    pytest tests/
```

---

## 11. æ€§èƒ½ä¼˜åŒ–

### 11.1 è¿æ¥æ± é…ç½®

```python
# src/database.py
from asyncpg import create_pool

pool = await create_pool(
    dsn=settings.database_url,
    min_size=5,
    max_size=20,
    command_timeout=60
)
```

### 11.2 ç¼“å­˜å±‚ï¼ˆRedisï¼‰

```bash
# Railway æ·»åŠ  Redis
New â†’ Database â†’ Redis
```

```python
import aioredis

redis = await aioredis.from_url(
    os.getenv("REDIS_URL"),
    encoding="utf-8",
    decode_responses=True
)

# ç¼“å­˜æŸ¥è¯¢ç»“æœ
await redis.setex(f"doctor:{doctor_id}", 3600, json.dumps(data))
```

---

## 12. å¸¸è§é—®é¢˜æ’æŸ¥

### 12.1 Webhook æ— å“åº”

```bash
# æ£€æŸ¥æ—¥å¿—
railway logs

# æµ‹è¯• webhook è¿é€šæ€§
curl https://your-app.up.railway.app/health
```

### 12.2 æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ DATABASE_URL
railway variables

# æ‰‹åŠ¨è¿æ¥æµ‹è¯•
railway connect postgres
```

### 12.3 API è°ƒç”¨å¤±è´¥

```python
# æ·»åŠ è¯¦ç»†é”™è¯¯æ—¥å¿—
logger.error(f"API call failed: {e}", exc_info=True)
```

---

## 13. æ‰©å±•éƒ¨ç½²

### 13.1 æ°´å¹³æ‰©å±•

```bash
# Railway å¢åŠ å®ä¾‹
Settings â†’ Scale â†’ Replicas: 2
```

### 13.2 è´Ÿè½½å‡è¡¡

Railway è‡ªåŠ¨æä¾›è´Ÿè½½å‡è¡¡ã€‚

---

## 14. éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- [ ] æ‰€æœ‰ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] Webhook URL å·²åœ¨ Meta åå°é…ç½®
- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º
- [ ] SSL è¯ä¹¦æœ‰æ•ˆï¼ˆRailway è‡ªåŠ¨ï¼‰
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] API å¯†é’¥æœ‰æ•ˆ
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ

---

## 15. å¿«é€Ÿéƒ¨ç½²å‘½ä»¤æ±‡æ€»

```bash
# 1. åˆå§‹åŒ– Railway é¡¹ç›®
railway login
railway init
railway link

# 2. æ·»åŠ  PostgreSQL
railway add --database postgres

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
railway variables set WHATSAPP_ACCESS_TOKEN=xxx
railway variables set GOOGLE_PLACES_API_KEY=xxx
railway variables set OPENAI_API_KEY=xxx

# 4. éƒ¨ç½²
railway up

# 5. åˆå§‹åŒ–æ•°æ®åº“
railway run python scripts/init_db.py

# 6. æŸ¥çœ‹æ—¥å¿—
railway logs --tail

# 7. æ‰“å¼€åº”ç”¨
railway open
```

---

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ çš„ WhatsApp Bot å°±ä¸Šçº¿äº†ï¼ğŸ‰
