# WhatsApp API æ¥å…¥æµç¨‹å›¾

> å¯è§†åŒ–å±•ç¤ºå®Œæ•´çš„æ¥å…¥å’Œæ¶ˆæ¯å¤„ç†æµç¨‹

---

## ğŸ“Š å®Œæ•´æ¥å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WhatsApp API æ¥å…¥æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Meta åå° â”‚  ä½ çš„æ“ä½œï¼šåˆ›å»ºåº”ç”¨ã€è·å–å‡­è¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Meta for Developers                                      â”‚
â”‚  â”œâ”€ My Apps â†’ Create App (Business)                       â”‚
â”‚  â”œâ”€ Add WhatsApp Product                                  â”‚
â”‚  â””â”€ API Setup:                                            â”‚
â”‚      â”œâ”€ Phone Number ID: 109361185504724                  â”‚
â”‚      â”œâ”€ Temporary Access Token: EAAGm7J...               â”‚
â”‚      â””â”€ Add Test Phone Number: +8613800138000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æœ¬åœ°é…ç½®  â”‚  è¿è¡Œè„šæœ¬ï¼š./scripts/setup_whatsapp.sh
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®è„šæœ¬åšä»€ä¹ˆï¼Ÿ                                          â”‚
â”‚  â”œâ”€ äº¤äº’å¼è¾“å…¥å‡­è¯                                         â”‚
â”‚  â”œâ”€ å¤‡ä»½åŸ .env æ–‡ä»¶                                       â”‚
â”‚  â”œâ”€ æ›´æ–°ç¯å¢ƒå˜é‡ï¼š                                         â”‚
â”‚  â”‚   WHATSAPP_PHONE_NUMBER_ID=109361185504724           â”‚
â”‚  â”‚   WHATSAPP_ACCESS_TOKEN=EAAGm7J...                   â”‚
â”‚  â”‚   VERIFY_TOKEN=my_secret_verify_token_123            â”‚
â”‚  â””â”€ æ˜¾ç¤ºä¸‹ä¸€æ­¥æç¤º                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å¯åŠ¨æœåŠ¡  â”‚  è¿è¡Œè„šæœ¬ï¼š./scripts/start_local_test.sh
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯åŠ¨è„šæœ¬åšä»€ä¹ˆï¼Ÿ                                          â”‚
â”‚  â”œâ”€ å¯åŠ¨ FastAPI (localhost:8000)                         â”‚
â”‚  â”‚   â”œâ”€ åŠ è½½ .env é…ç½®                                    â”‚
â”‚  â”‚   â”œâ”€ è¿æ¥æ•°æ®åº“                                        â”‚
â”‚  â”‚   â””â”€ æ³¨å†Œ Webhook è·¯ç”±                                 â”‚
â”‚  â””â”€ å¯åŠ¨ ngrok                                            â”‚
â”‚      â”œâ”€ å»ºç«‹éš§é“: localhost:8000 â†’ å…¬ç½‘                   â”‚
â”‚      â””â”€ ç”Ÿæˆ URL: https://abc123.ngrok-free.app          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é…ç½®å›è°ƒ  â”‚  Meta åå°ï¼šConfiguration â†’ Webhook
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Meta Webhook é…ç½®                                        â”‚
â”‚  â”œâ”€ Callback URL:                                         â”‚
â”‚  â”‚   https://abc123.ngrok-free.app/webhook/whatsapp     â”‚
â”‚  â”œâ”€ Verify Token:                                         â”‚
â”‚  â”‚   my_secret_verify_token_123                          â”‚
â”‚  â””â”€ ç‚¹å‡» "Verify and Save"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. éªŒè¯æµç¨‹  â”‚  Meta â†’ ä½ çš„æœåŠ¡å™¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webhook éªŒè¯ï¼ˆGET è¯·æ±‚ï¼‰                                  â”‚
â”‚                                                           â”‚
â”‚  Meta å‘é€:                                               â”‚
â”‚  GET /webhook/whatsapp?                                   â”‚
â”‚      hub.mode=subscribe                                   â”‚
â”‚      hub.verify_token=my_secret_verify_token_123         â”‚
â”‚      hub.challenge=RANDOM_STRING                         â”‚
â”‚                                                           â”‚
â”‚  ä½ çš„æœåŠ¡å™¨:                                               â”‚
â”‚  1. æ£€æŸ¥ verify_token æ˜¯å¦åŒ¹é…                            â”‚
â”‚  2. è¿”å› challenge å€¼                                     â”‚
â”‚                                                           â”‚
â”‚  Meta æ”¶åˆ°:                                               â”‚
â”‚  âœ… ç»¿è‰²å‹¾å· = éªŒè¯æˆåŠŸ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è®¢é˜…äº‹ä»¶  â”‚  Meta åå°ï¼šå‹¾é€‰ messages
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webhook Fields                                           â”‚
â”‚  â˜‘ï¸ messages  â† å¿…é¡»å‹¾é€‰                                   â”‚
â”‚  â˜ message_status                                         â”‚
â”‚  â˜ messaging_postbacks                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æµ‹è¯•æ¶ˆæ¯  â”‚  è¿è¡Œè„šæœ¬ï¼š./scripts/test_webhook.sh
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
       âœ… æ¥å…¥å®Œæˆï¼
```

---

## ğŸ”„ æ¶ˆæ¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å‘é€æ¶ˆæ¯åçš„å¤„ç†æµç¨‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ· WhatsAppâ”‚  å‘é€æ¶ˆæ¯ï¼š"æåŒ»ç”Ÿ"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Business API (Meta äº‘ç«¯)                        â”‚
â”‚  â”œâ”€ æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯                                           â”‚
â”‚  â”œâ”€ å°è£…ä¸º Webhook Payload                                â”‚
â”‚  â””â”€ POST åˆ°ä½ çš„ Callback URL                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“  POST /webhook/whatsapp
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä½ çš„ FastAPI æœåŠ¡å™¨                                        â”‚
â”‚  (src/whatsapp/routes.py)                                 â”‚
â”‚                                                           â”‚
â”‚  async def receive_webhook(request):                      â”‚
â”‚    1. è§£æ JSON body                                       â”‚
â”‚    2. æå– from_number, message_text                       â”‚
â”‚    3. åˆ›å»ºå¼‚æ­¥ä»»åŠ¡å¤„ç†                                      â”‚
â”‚    4. ç«‹å³è¿”å› 200 OK (ä¸é˜»å¡)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“  å¼‚æ­¥å¤„ç†
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯å¤„ç†å™¨ (src/whatsapp/handler.py)                      â”‚
â”‚                                                           â”‚
â”‚  async def process_message(from, text):                   â”‚
â”‚    â”œâ”€ 1. æ£€æŸ¥ç”¨æˆ·é…é¢ (50æ¬¡/å¤©)                            â”‚
â”‚    â”œâ”€ 2. æå–åŒ»ç”Ÿå§“å                                       â”‚
â”‚    â”œâ”€ 3. å‘é€"æ­£åœ¨æœç´¢..."æ¶ˆæ¯                              â”‚
â”‚    â””â”€ 4. è°ƒç”¨æœç´¢èšåˆå™¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢èšåˆå™¨ (src/search/aggregator.py)                     â”‚
â”‚                                                           â”‚
â”‚  async def search_doctor_reviews(doctor_name):            â”‚
â”‚    â”œâ”€ 1. ç”Ÿæˆ doctor_id (hash)                            â”‚
â”‚    â”œâ”€ 2. æ£€æŸ¥ç¼“å­˜                                          â”‚
â”‚    â”‚    â””â”€ å¦‚æœå‘½ä¸­ â†’ ç›´æ¥è¿”å›                              â”‚
â”‚    â”œâ”€ 3. å¹¶è¡Œè°ƒç”¨æœç´¢å¼•æ“ï¼š                                 â”‚
â”‚    â”‚    â”œâ”€ Google Places API                              â”‚
â”‚    â”‚    â”œâ”€ Facebook Graph API                             â”‚
â”‚    â”‚    â””â”€ Mock Searcher (å¼€å‘æ¨¡å¼)                        â”‚
â”‚    â”œâ”€ 4. åˆå¹¶æ‰€æœ‰ç»“æœ                                       â”‚
â”‚    â””â”€ 5. è°ƒç”¨æƒ…æ„Ÿåˆ†æ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒ…æ„Ÿåˆ†æ (src/analysis/sentiment.py)                      â”‚
â”‚                                                           â”‚
â”‚  async def analyze_reviews(reviews):                      â”‚
â”‚    â”œâ”€ 1. æ£€æŸ¥æ˜¯å¦ Mock æ¨¡å¼                                â”‚
â”‚    â”œâ”€ 2. æ‰¹é‡è°ƒç”¨ OpenAI API (10æ¡/æ‰¹)                     â”‚
â”‚    â”‚    â””â”€ GPT-4-turbo/GPT-5-mini                         â”‚
â”‚    â”œâ”€ 3. è§£æ JSON ç»“æœ                                    â”‚
â”‚    â””â”€ 4. ä¸ºæ¯æ¡è¯„ä»·æ·»åŠ  sentiment å­—æ®µ                     â”‚
â”‚         (positive/negative/neutral)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å­˜ç®¡ç†å™¨ (src/cache/manager.py)                         â”‚
â”‚                                                           â”‚
â”‚  async def save_reviews(doctor_id, reviews):              â”‚
â”‚    â”œâ”€ 1. ä¿å­˜åˆ° doctors è¡¨                                 â”‚
â”‚    â”œâ”€ 2. ä¿å­˜åˆ° reviews è¡¨                                 â”‚
â”‚    â””â”€ 3. è®¾ç½® TTL = 7 å¤©                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯æ ¼å¼åŒ– (src/whatsapp/formatter.py)                    â”‚
â”‚                                                           â”‚
â”‚  def format_review_batch(batch, doctor_name, ...):        â”‚
â”‚    â”œâ”€ 1. æ˜¾ç¤ºé…é¢ä¿¡æ¯ï¼ˆé¦–æ‰¹ï¼‰                               â”‚
â”‚    â”œâ”€ 2. æ ¼å¼åŒ–è¯„è®ºåˆ—è¡¨ï¼š                                   â”‚
â”‚    â”‚    ğŸ“Š Monthly quota: 497/500 searches remaining      â”‚
â”‚    â”‚                                                       â”‚
â”‚    â”‚    ğŸ” æåŒ»ç”Ÿ                                           â”‚
â”‚    â”‚    Found 10 reviews                                   â”‚
â”‚    â”‚                                                       â”‚
â”‚    â”‚    1. "æåŒ»ç”Ÿéå¸¸ä¸“ä¸š..."                              â”‚
â”‚    â”‚       ğŸ“… 2024-10-15                                   â”‚
â”‚    â”‚       ğŸ”— https://...                                  â”‚
â”‚    â”‚                                                       â”‚
â”‚    â”‚    2. "ç­‰å¾…æ—¶é—´è¾ƒé•¿..."                                â”‚
â”‚    â”‚       ğŸ“… 2024-10-10                                   â”‚
â”‚    â”‚       ğŸ”— https://...                                  â”‚
â”‚    â””â”€ 3. æ·»åŠ æ¥æºè¯´æ˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp å®¢æˆ·ç«¯ (src/whatsapp/client.py)                  â”‚
â”‚                                                           â”‚
â”‚  async def send_message(to, message):                     â”‚
â”‚    â”œâ”€ 1. æ„é€  API è¯·æ±‚                                     â”‚
â”‚    â”‚    POST https://graph.facebook.com/v18.0/          â”‚
â”‚    â”‚         {phone_number_id}/messages                  â”‚
â”‚    â”œâ”€ 2. è®¾ç½® Authorization: Bearer {access_token}       â”‚
â”‚    â””â”€ 3. å‘é€æ¶ˆæ¯                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsApp Business API                                    â”‚
â”‚  â””â”€ æ¨é€æ¶ˆæ¯åˆ°ç”¨æˆ· WhatsApp                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ· WhatsAppâ”‚  æ”¶åˆ°æ ¼å¼åŒ–çš„è¯„ä»·æ±‡æ€»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è€—æ—¶ï¼š
â”œâ”€ ç¼“å­˜å‘½ä¸­ï¼š< 500ms
â””â”€ ç¼“å­˜æœªå‘½ä¸­ï¼š2-5s (å–å†³äº API å“åº”)
```

---

## ğŸ” æ•°æ®æµè¯¦è§£

### 1ï¸âƒ£ Webhook Payload ç¤ºä¾‹

**ç”¨æˆ·å‘é€ "æåŒ»ç”Ÿ"ï¼ŒMeta æ¨é€ï¼š**

```json
{
  "object": "whatsapp_business_account",
  "entry": [
    {
      "id": "WHATSAPP_BUSINESS_ACCOUNT_ID",
      "changes": [
        {
          "value": {
            "messaging_product": "whatsapp",
            "metadata": {
              "display_phone_number": "15550100",
              "phone_number_id": "109361185504724"
            },
            "contacts": [
              {
                "profile": {
                  "name": "Lucy"
                },
                "wa_id": "8613800138000"
              }
            ],
            "messages": [
              {
                "from": "8613800138000",
                "id": "wamid.xxx",
                "timestamp": "1696800000",
                "text": {
                  "body": "æåŒ»ç”Ÿ"
                },
                "type": "text"
              }
            ]
          },
          "field": "messages"
        }
      ]
    }
  ]
}
```

### 2ï¸âƒ£ æœç´¢ç»“æœç¤ºä¾‹

**ä»å¤šä¸ªæ¥æºèšåˆï¼š**

```json
[
  {
    "text": "æåŒ»ç”Ÿéå¸¸ä¸“ä¸šï¼Œæ€åº¦å¾ˆå¥½ï¼Œè¯Šæ–­å‡†ç¡®",
    "source": "google_maps",
    "source_url": "https://maps.google.com/...",
    "rating": 5,
    "date": "2025-09-15"
  },
  {
    "text": "ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œä½†åŒ»ç”Ÿå¾ˆè€å¿ƒ",
    "source": "facebook",
    "source_url": "https://facebook.com/...",
    "date": "2025-09-20"
  }
]
```

### 3ï¸âƒ£ æƒ…æ„Ÿåˆ†æç»“æœ

**OpenAI åˆ†æåï¼š**

```json
[
  {
    "text": "æåŒ»ç”Ÿéå¸¸ä¸“ä¸šï¼Œæ€åº¦å¾ˆå¥½ï¼Œè¯Šæ–­å‡†ç¡®",
    "source": "google_maps",
    "source_url": "https://maps.google.com/...",
    "sentiment": "positive",  â† æ–°å¢å­—æ®µ
    "rating": 5,
    "date": "2025-09-15"
  },
  {
    "text": "ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œä½†åŒ»ç”Ÿå¾ˆè€å¿ƒ",
    "source": "facebook",
    "source_url": "https://facebook.com/...",
    "sentiment": "neutral",  â† æ–°å¢å­—æ®µ
    "date": "2025-09-20"
  }
]
```

### 4ï¸âƒ£ è¿”å›ç»™ç”¨æˆ·çš„æ¶ˆæ¯

```
ğŸ“Š æåŒ»ç”Ÿ - è¯„ä»·æ±‡æ€»

âœ… æ­£é¢è¯„ä»· (1æ¡)
1. æåŒ»ç”Ÿéå¸¸ä¸“ä¸šï¼Œæ€åº¦å¾ˆå¥½ï¼Œè¯Šæ–­å‡†ç¡®
   ğŸ—ºï¸ Google Maps
   ğŸ”— https://maps.google.com/...
   ğŸ“… 2025-09-15

âš–ï¸ ä¸­æ€§è¯„ä»· (1æ¡)
2. ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œä½†åŒ»ç”Ÿå¾ˆè€å¿ƒ
   ğŸ‘¥ Facebook
   ğŸ”— https://facebook.com/...
   ğŸ“… 2025-09-20

ğŸ’¡ æç¤ºï¼šä¿¡æ¯æ¥è‡ªå…¬å¼€è¯„ä»·ï¼Œä»…ä¾›å‚è€ƒ
```

---

## ğŸ› ï¸ å…³é”®ç»„ä»¶èŒè´£

### FastAPI è·¯ç”±å±‚
```python
# src/whatsapp/routes.py

@router.get("/whatsapp")    # Webhook éªŒè¯
@router.post("/whatsapp")   # æ¥æ”¶æ¶ˆæ¯
@router.post("/whatsapp/test")  # æµ‹è¯•ç«¯ç‚¹
```

### æ¶ˆæ¯å¤„ç†å±‚
```python
# src/whatsapp/handler.py

class MessageHandler:
    - é…é¢æ£€æŸ¥
    - å‘½ä»¤è¯†åˆ«
    - è°ƒç”¨æœç´¢
    - æ—¥å¿—è®°å½•
```

### æœç´¢èšåˆå±‚
```python
# src/search/aggregator.py

class SearchAggregator:
    - ç¼“å­˜æ£€æŸ¥
    - å¹¶è¡Œæœç´¢
    - ç»“æœåˆå¹¶
    - æƒ…æ„Ÿåˆ†æ
```

### æƒ…æ„Ÿåˆ†æå±‚
```python
# src/analysis/sentiment.py

class SentimentAnalyzer:
    - OpenAI API è°ƒç”¨
    - æ‰¹é‡å¤„ç†
    - Mock æ¨¡å¼
```

### ç¼“å­˜ç®¡ç†å±‚
```python
# src/cache/manager.py

class CacheManager:
    - ç”Ÿæˆ doctor_id
    - è¯»å–ç¼“å­˜
    - ä¿å­˜ç»“æœ
    - TTL ç®¡ç†
```

---

## â±ï¸ æ€§èƒ½æŒ‡æ ‡

| åœºæ™¯ | å“åº”æ—¶é—´ | API è°ƒç”¨ | æˆæœ¬ |
|------|---------|---------|------|
| ç¼“å­˜å‘½ä¸­ | < 500ms | 0 | $0 |
| é¦–æ¬¡æŸ¥è¯¢ | 2-5s | Google + OpenAI | ~$0.01 |
| çƒ­é—¨åŒ»ç”Ÿ | < 1s | 0 | $0 |
| Mock æ¨¡å¼ | < 300ms | 0 | $0 |

---

## ğŸ” å®‰å…¨æ£€æŸ¥ç‚¹

```
ç”¨æˆ·è¾“å…¥ â†’ é…é¢æ£€æŸ¥ â†’ è¾“å…¥æ¸…æ´— â†’ ä¸šåŠ¡å¤„ç†
                â†“           â†“          â†“
            é™æµä¿æŠ¤    SQLæ³¨å…¥é˜²æŠ¤  å¼‚å¸¸æ•è·
```

---

è¿™ä¸ªæµç¨‹å›¾å¸®åŠ©ä½ ç†è§£ï¼š
1. âœ… å¦‚ä½•ä»é›¶å¼€å§‹æ¥å…¥ WhatsApp API
2. âœ… æ¶ˆæ¯æ˜¯å¦‚ä½•ä»ç”¨æˆ·åˆ°è¾¾ä½ çš„æœåŠ¡å™¨
3. âœ… ä½ çš„ä»£ç å¦‚ä½•å¤„ç†å’Œå“åº”æ¶ˆæ¯
4. âœ… æ¯ä¸ªç»„ä»¶çš„èŒè´£å’Œæ•°æ®æµå‘

å‚è€ƒæ­¤å›¾è¿›è¡Œè°ƒè¯•å’Œä¼˜åŒ–ï¼ğŸš€
